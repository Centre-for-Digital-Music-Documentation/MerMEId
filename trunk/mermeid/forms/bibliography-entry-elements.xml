<h:fieldset xmlns="http://www.music-encoding.org/ns/mei" 
	xmlns:t="http://www.tei-c.org/ns/1.0" 
	xmlns:h="http://www.w3.org/1999/xhtml"
	xmlns:xf="http://www.w3.org/2002/xforms" 
	xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
	xmlns:ev="http://www.w3.org/2001/xml-events" 
	xmlns:dcm="http://www.kb.dk/dcm"
	class="bibl-fieldset">
	
	<h:legend>
		<xf:output value="translate(concat(translate(substring(@type,1,1),'abcdefghijklmnopqrstuvwxyz','ABCDEFGHIJKLMNOPQRSTUVWXYZ'),substring(@type,2)),'_',' ')"/> 
		<dcm:element-buttons 
			triggers="up down copy" 
			nodeset="t:bibl" 
			index="repeat-bibl"
			origin="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[1]/t:bibl[1]"/><xf:trigger appearance="minimal"
				class="non-standard_button">
				<xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/></xf:label>
				<xf:action ev:event="DOMActivate">
					<xxf:show dialog="add-ref-dialog"/>
				</xf:action>
			</xf:trigger><dcm:element-buttons 
				triggers="delete" 
				nodeset="t:bibl" 
				index="repeat-bibl"
				origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[1]/t:bibl[1]"/>
	</h:legend>
	
	<!-- reference types menu -->
	<xxf:dialog id="add-ref-dialog" appearance="full" level="modal"
		close="true" draggable="true" visible="false">
		<h:div class="blocklabel">Add new reference:</h:div>
		<h:br clear="all"/>
		<xf:repeat nodeset="instance('bibl-type-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]/@type]/t:bibl" 
			id="ref-type-menu-repeat">
			<xf:output value="concat('listbibltype: ',instance('data-instance')/m:music/m:front/t:div/t:listBibl[index('repeat-listbibl')]/@type"/>
			<xf:trigger submission="replace-form-with" appearance="minimal" class="non-standard_trigger">
				<xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/> <xf:output ref="translate(@type,'_',' ')"/></xf:label>
				<xf:action ev:event="DOMActivate">
					<xf:toggle case="hide_ref_types"/>
					<xf:insert context="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]" 
						nodeset="t:bibl" 
						at="index('repeat-bibl')"
						position="after" 
						origin="instance('bibl-type-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]/@type]/t:bibl[index('ref-type-menu-repeat')]"/>
					<xxf:hide dialog="add-ref-dialog"/>
				</xf:action>
			</xf:trigger>
			<h:br clear="all"/>
		</xf:repeat>
		<xf:repeat nodeset="instance('bibl-type-instance')/t:listBibl[not(@type)]/t:bibl" id="ref-type-menu-repeat2">
			<xf:output value="concat('listbibltype: ',instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]/@type"/>
			<xf:trigger submission="replace-form-with" appearance="minimal">
				<xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/> <xf:output ref="translate(@type,'_',' ')"/></xf:label>
				<xf:action ev:event="DOMActivate">
					<xf:toggle case="hide_ref_types"/>
					<xf:insert context="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]" 
						nodeset="t:bibl" 
						at="index('repeat-bibl')"
						position="after" 
						origin="instance('bibl-type-instance')/t:listBibl[not(@type)]/t:bibl[index('ref-type-menu-repeat2')]"/>
					<xxf:hide dialog="add-ref-dialog"/>
				</xf:action>
			</xf:trigger>
			<h:br clear="all"/>
		</xf:repeat>
		<!-- standard references quick-add menu -->
		<xf:group ref=".[count(instance('bibliography-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:seriesStmt/m:seriesStmt[@label='File collection']/m:identifier])&gt;0]">
			<h:hr style="margin:10px 0px;"/>
			<h:div class="blocklabel">Standard references:</h:div>
			<h:br clear="all"/>
			<xf:repeat nodeset="instance('bibliography-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:seriesStmt/m:seriesStmt[@label='File collection']/m:identifier]" id="std-bibl-repeat">
				<xf:repeat nodeset="t:bibl" id="std-bibl-menu-repeat">
					<xf:trigger submission="replace-form-with" appearance="minimal">
						<xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/> <xf:output ref="t:abbr"/></xf:label>
						<xf:action ev:event="DOMActivate">
							<xf:insert context="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]"
								nodeset="t:bibl"
								at="index('repeat-bibl')" 
								position="after" 
								origin="instance('bibliography-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:seriesStmt/m:seriesStmt[@label='File collection']/m:identifier][index('std-bibl-repeat')]/t:bibl[index('std-bibl-menu-repeat')]"/>
							<xxf:hide dialog="add-ref-dialog"/>
						</xf:action>
					</xf:trigger>
					<h:br clear="all"/>
				</xf:repeat>
			</xf:repeat>
		</xf:group>
	</xxf:dialog>
	<!-- end menu -->
	
	<xf:group ref=".[@type!='Letter' and translate(@type,' ','_')!='Diary_entry' and translate(@type,' ','_')!='Concert_programme']">
		
		<xf:group ref="t:author[../translate(@type,' ','_')!='Newspaper_article']">
			<!-- authors are listed elsewhere if newspaper article -->
			<h:fieldset>
				<h:legend>Authors</h:legend>
				<xf:repeat nodeset="." id="repeat-bibl-author">
					<h:div>
						<xf:input ref="." class="long">
							<xf:label class="fixed_width_short">Name</xf:label>
						</xf:input>
						<dcm:element-buttons 
							triggers="add delete" 
							nodeset="t:author" 
							index="repeat-bibl-author"
							origin="instance('bibl-type-instance')/t:listBibl/t:bibl[t:author]/t:author"/>
					</h:div>
				</xf:repeat>
			</h:fieldset>
		</xf:group>
		
		<h:fieldset>
			<h:legend>Title</h:legend>
			<xf:repeat nodeset="t:title" id="repeat-bibl-title">
				<h:div>
					<xf:input ref="." class="long">
						<xf:label class="fixed_width">
							<xf:output value="if (@level='a') then 'Article' else ''"/>
							<xf:output value="if (@level='j') then tokenize(translate(../@type,' ','_'),'_')[1] else ''"/>
							<xf:output value="if (@level='m') then 'Monograph' else ''"/>
							<xf:output value="if (@level='s') then 'Series' else ''"/>
						</xf:label>
					</xf:input>
				</h:div>
			</xf:repeat>
		</h:fieldset>
		
		<xf:group ref="t:date[../translate(@type,' ','_')='Newspaper_article']">
			<!-- newspaper article date here -->
			<h:div>
				<dcm:tei-date-editor ref=".">
					<xf:label class="fixed_width">Date </xf:label>
				</dcm:tei-date-editor>
			</h:div>
		</xf:group>
		
		<xf:switch>
			<xf:case id="hide_details" selected="true()">
				<xf:trigger class="detail_button">
					<xf:label>Show details</xf:label>
					<xf:toggle case="show_details" ev:event="DOMActivate"/>
				</xf:trigger>
			</xf:case>
			
			<xf:case id="show_details" selected="false()">
				<xf:trigger class="detail_button">
					<xf:label>Hide details</xf:label>
					<xf:toggle case="hide_details" ev:event="DOMActivate"/>
				</xf:trigger>					
				
				<xf:group ref="t:author[../translate(@type,' ','_')='Newspaper_article']">
					<!-- newspaper article author here -->
					<h:fieldset>
						<h:legend>Authors</h:legend>
						<xf:repeat nodeset="." id="repeat-bibl-newspaper-author">
							<h:div>
								<xf:input ref="." class="long">
									<xf:label class="fixed_width_short">Name</xf:label>
								</xf:input>
								<dcm:element-buttons 
									triggers="add delete" 
									nodeset="t:author" 
									index="repeat-bibl-author"
									origin="instance('bibl-type-instance')/t:listBibl/t:bibl[t:author]/t:author"/>
							</h:div>
						</xf:repeat>
					</h:fieldset>
				</xf:group>				
				
				<h:fieldset>
					<h:legend>Volume etc. <h:a class="help">?<h:span class="comment">Volume and issue no. to be displayed as vol./no. For journal articles, 
						the year displayed will be taken from publication date below. For example, a reference to The Musical Quarterly 88/3 (2005), pp.339-341 should be divided as follows: <h:br/>
						"88" goes in <h:em>Volume</h:em>, "3" in <h:em>No.</h:em>, "339-341" in <h:em>Pages</h:em> and "2005" in <h:em>Date</h:em> (under "Publication", see below).<h:br/>
						For references to more than one volume, additional sets of volume/no./pages can be added.
					</h:span></h:a> 
						<xf:trigger appearance="minimal">
							<xf:label><h:img src="http:/editor/images/add.gif" alt="Add" title="Add volume, number, and pages" style="vertical-align:text-top;"/></xf:label>
							<xf:action ev:event="DOMActivate">
								<xxf:variable name="ref_type" select="@type"/>
								<xf:insert nodeset="t:biblScope" at="last()" position="after"
									origin="instance('bibl-type-instance')/t:listBibl/t:bibl[@type=$ref_type]/t:biblScope"/>
							</xf:action>
						</xf:trigger>
					</h:legend>
					<xf:repeat nodeset="t:biblScope" id="repeat-bibl-biblscope">
						<h:div>
							<xf:input ref=".">
								<xf:label class="fixed_width_short">
									<xf:output value="if (@type='vol') then 'Volume' else ''"/>
									<xf:output value="if (@type='issue') then 'No.' else ''"/>
									<xf:output value="if (@type='pp') then 'Pages' else ''"/>
								</xf:label>
							</xf:input>
							<xf:trigger ref="../t:biblScope[last()&gt;1]" appearance="minimal">
								<xf:label>
									<h:img src="http:/editor/images/remove.gif" alt="Delete" title="Delete"/>
								</xf:label>
								<xf:delete nodeset="../t:biblScope" at="index('repeat-bibl-biblscope')" ev:event="DOMActivate"/>
							</xf:trigger>
						</h:div>
					</xf:repeat>
				</h:fieldset>
				
				<xf:group ref="t:editor">
					<h:fieldset>
						<h:legend>Editors</h:legend>
						<xf:repeat nodeset="." id="repeat-bibl-editor">
							<h:div>
								<xf:input ref="." class="long">
									<xf:label class="fixed_width_short">Name</xf:label>
								</xf:input>
								<dcm:element-buttons 
									triggers="add delete" 
									nodeset="t:editor" 
									index="repeat-bibl-editor"
									origin="instance('bibl-type-instance')/t:listBibl/t:bibl[t:editor]/t:editor"/>
							</h:div>
						</xf:repeat>
					</h:fieldset>
				</xf:group>
				
				
				<xf:group ref=".[translate(@type,' ','_')!='Newspaper_article']">
					<!-- publication date etc. listed elsewhere if newspaper article -->
					<h:fieldset>
						<h:legend>Publication</h:legend>
						<h:div>
							<xf:input ref="t:publisher">
								<xf:label class="fixed_width">Publisher</xf:label>
							</xf:input>
						</h:div>
						<h:div>
							<xf:input ref="t:pubPlace">
								<xf:label class="fixed_width">Place</xf:label>
							</xf:input>
						</h:div>
						<h:div>
							<dcm:tei-date-editor ref="t:date">
								<xf:label class="fixed_width">Date </xf:label>
							</dcm:tei-date-editor>
						</h:div>
					</h:fieldset>
				</xf:group>
				
				<xf:repeat nodeset="t:ref[@type!='editions' or count(@type)=0]">
					<h:div>
						<xf:input ref="@target" class="long">
							<xf:label>URI (link to fulltext)</xf:label>
						</xf:input>
					</h:div>
				</xf:repeat>
				
				<xf:group ref="t:ref[@type='editions']">
					<h:fieldset>
						<h:legend>Editions</h:legend>
						<xf:repeat nodeset="t:bibl" id="repeat-bibl-editions">
							<h:div>
								<xf:input ref="t:title[@type='short_title']">
									<xf:label>Short title <h:a class="help">?<h:span class="comment">A short-hand reference to the publication quoting this item, e.g.
										"CNB" or "Mozart: Briefe"</h:span></h:a></xf:label>
								</xf:input> <xf:input ref="t:biblScope">
									<xf:label>Page or No. <h:a class="help">?<h:span class="comment">The number of this item in the edition or the relevant pages, e.g. "IV/345" </h:span></h:a></xf:label>
								</xf:input>
								<dcm:element-buttons 
									triggers="add delete" 
									nodeset="t:bibl" 
									index="repeat-letter-editions"
									origin="instance('bibl-type-instance')/t:listBibl/t:bibl/t:ref[@type='editions']/t:bibl[1]"/>
							</h:div>
						</xf:repeat>
					</h:fieldset>
				</xf:group>
			</xf:case>
		</xf:switch>
	</xf:group>
	
	<xf:group ref=".[@type='Letter' or translate(@type,' ','_')='Diary_entry']">
		<xf:input ref="t:author" class="long">
			<xf:label class="fixed_width">Author <h:a class="help">?<h:span class="comment">For diary entries, leave empty if author is the composer</h:span></h:a></xf:label>
		</xf:input>
		<h:br clear="all"/>
		<xf:group ref=".[@type='Letter']">
			<xf:input ref="t:name[@role='recipient']" class="long">
				<xf:label class="fixed_width">Recipient</xf:label>
			</xf:input>
			<h:br clear="all"/>
		</xf:group>
		<dcm:tei-date-editor ref="t:date">
			<xf:label class="fixed_width">Date </xf:label>
		</dcm:tei-date-editor>
		<xf:switch>
			<xf:case id="hide_letter_details" selected="true()">
				<xf:trigger class="detail_button">
					<xf:label>Show details</xf:label>
					<xf:toggle case="show_letter_details" ev:event="DOMActivate"/>
				</xf:trigger>
			</xf:case>
			
			<xf:case id="show_letter_details" selected="false()">
				<xf:trigger class="detail_button">
					<xf:label>Hide details</xf:label>
					<xf:toggle case="hide_letter_details" ev:event="DOMActivate"/>
				</xf:trigger>
				
				<h:fieldset>
					<h:legend>Location</h:legend>
					<xf:input ref="t:msIdentifier/t:repository">
						<xf:label class="fixed_width_long">Repository name <h:a class="help">?<h:span class="comment">The library, archive or other repository holding this item,
							e.g. "DK-Kk"</h:span></h:a></xf:label>
					</xf:input>
					<xf:input ref="t:msIdentifier/t:idno">
						<xf:label>Shelfmark <h:a class="help">?<h:span class="comment">The shelfmark or other signature identfying the item in the
							repository</h:span></h:a></xf:label>
					</xf:input>
					<xf:repeat nodeset="t:ref[@type!='editions' or count(@type)=0]">
						<h:div>
							<xf:input ref="@target" class="long">
								<xf:label class="fixed_width_long">URI <h:a class="help">?<h:span class="comment">Link to fulltext or facsimile,
									e.g. http://example.org/document.html</h:span></h:a></xf:label>
							</xf:input>
						</h:div>
					</xf:repeat>
				</h:fieldset>
				
				<h:fieldset>
					<h:legend>Editions</h:legend>
					<xf:repeat nodeset="t:ref[@type='editions']/t:bibl" id="repeat-letter-editions">
						<h:div>
							<xf:input ref="t:title[@type='short_title']">
								<xf:label>Short title <h:a class="help">?<h:span class="comment">A short-hand reference to the publication quoting this item, e.g.
									"CNB" or "Mozart: Briefe"</h:span></h:a></xf:label>
							</xf:input> <xf:input ref="t:biblScope">
								<xf:label>Page or No. <h:a class="help">?<h:span class="comment">The number of this item in the edition or the relevant pages, e.g. "IV/345" </h:span></h:a></xf:label>
							</xf:input>
							<dcm:element-buttons 
								triggers="add delete" 
								nodeset="t:bibl" 
								index="repeat-letter-editions"
								origin="instance('bibl-type-instance')/t:listBibl/t:bibl/t:ref[@type='editions']/t:bibl[1]"/>
						</h:div>
					</xf:repeat>
				</h:fieldset>
			</xf:case>
		</xf:switch>
	</xf:group>
	
	<xf:group ref=".[translate(@type,' ','_')='Concert_programme']">
		<h:div>
			<xf:input ref="t:title" class="long">
				<xf:label class="fixed_width">Title </xf:label>
			</xf:input>
		</h:div>
		<h:div>
			<xf:input ref="t:date">
				<xf:label class="fixed_width">Date <h:a class="help">?<h:span class="comment">Date is given (if possible) as yyyy-mm-dd, e.g.
					"1918-02-28"</h:span></h:a></xf:label>
			</xf:input>
		</h:div>			
		<h:div>
			<xf:input ref="t:geogName">
				<xf:label class="fixed_width">Place</xf:label>
			</xf:input>
			
			<xf:switch>
				<xf:case id="hide_programme_details" selected="true()">
					<xf:trigger class="detail_button">
						<xf:label>Show details</xf:label>
						<xf:toggle case="show_programme_details" ev:event="DOMActivate"/>
					</xf:trigger>
				</xf:case>
				
				<xf:case id="show_programme_details" selected="false()">
					<xf:trigger class="detail_button">
						<xf:label>Hide details</xf:label>
						<xf:toggle case="hide_programme_details" ev:event="DOMActivate"/>
					</xf:trigger>
					
					<h:fieldset>
						<h:legend>Location</h:legend>
						<xf:input ref="t:msIdentifier/t:repository">
							<xf:label class="fixed_width_long">Repository name <h:a class="help">?<h:span class="comment">The library, archive or other repository holding this item,
								e.g. "DK-Kk"</h:span></h:a></xf:label>
						</xf:input>
						<xf:input ref="t:msIdentifier/t:idno">
							<xf:label>Shelfmark <h:a class="help">?<h:span class="comment">The shelfmark or other signature identfying the item in the
								repository</h:span></h:a></xf:label>
						</xf:input>
						<xf:repeat nodeset="t:ref[@type='' or count(@type)=0]">
							<h:div>
								<xf:input ref="@target" class="long">
									<xf:label class="fixed_width_long">URI <h:a class="help">?<h:span class="comment">Link to fulltext or facsimile,
										e.g. http://example.org/document.html</h:span></h:a></xf:label>
								</xf:input>
							</h:div>
						</xf:repeat>
					</h:fieldset>						
				</xf:case>
			</xf:switch>				
		</h:div>
	</xf:group>
	
</h:fieldset>
