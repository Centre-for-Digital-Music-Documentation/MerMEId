<?xml version="1.0" encoding="UTF-8" ?>  
<h:head xmlns:h="http://www.w3.org/1999/xhtml" 
	xmlns:xi="http://www.w3.org/2001/XInclude"
	xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
	xmlns:xf="http://www.w3.org/2002/xforms" 
	xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
	xmlns:oxf="http://www.orbeon.com/oxf/processors"
	xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
	xmlns:ev="http://www.w3.org/2001/xml-events" 
	xmlns:xl="http://www.w3.org/1999/xlink"
	xmlns:xs="http://www.w3.org/2001/XMLSchema" 
	xmlns:m="http://www.music-encoding.org/ns/mei"
	xmlns:t="http://www.tei-c.org/ns/1.0" 
	xmlns:dcm="http://www.kb.dk/dcm">

  
  <h:title id="PageTitle">MerMEId - Editing MEI metadata</h:title>
  
  <h:meta http-equiv="Content-Type" content="application/xhtml+xml"/>
  
  <h:script type="text/javascript" src="http:/editor/js/editor.js">
    //<!-- should'nt really be empty -->
  </h:script>
  
  <h:style type="text/css" media="all"> 
    @import "/editor/style/tab_style.css"; 
    @import "/editor/style/xform_style.css";
  </h:style>
  
  <xf:model>
    
    <!--
	To construct model, call with url like: 
	http://disdev-01.kb.dk/orbeon/xforms-jsp/mei-form/?uri=http://disdev-01.kb.dk/editor/forms/mei/edit_mei_form.xml?&dir=http://disdev-01.kb.dk/storage/dcm&doc=cnw0292.xml
	- XInclude fails because the base url for relative paths is something like [...]/home/tomcat6/ 
    -->
    <xf:instance id="parameters" xmlns="http://www.kb.dk/dcm">
      <xi:include href="mermeid_configuration.xml" parse="xml"/>
    </xf:instance>
    
    <!-- prepare instances -->
    <xf:instance id="data-instance" xmlns="http://www.music-encoding.org/ns/mei">
      <mei/>
    </xf:instance>


    <!-- We will need instances without these /..  
	 Removed the /..s 14/6. SLU -->

    <xf:instance xmlns="http://www.music-encoding.org/ns/mei" 
		 id="empty-instance"
		 src="/editor/forms/mei/model/empty_doc.xml" 
		 xxf:readonly="true"/>

    <xf:instance xmlns="http://www.music-encoding.org/ns/mei" 
		 id="keywords-instance" 
		 src="/editor/forms/mei/model/keywords.xml" 
		 xxf:readonly="true"/>

    <xf:instance xmlns="http://www.music-encoding.org/ns/mei"
		 id="languages" 
		 src="/editor/forms/mei/model/languages.xml" 
		 xxf:readonly="true"/>

    <xf:instance xmlns="http://www.tei-c.org/ns/1.0" 
		 id="bibl-type-instance" 
		 src="/editor/forms/mei/model/bibl_reference_types.xml" 
		 xxf:readonly="true"/>

    <xf:instance xmlns="http://www.tei-c.org/ns/1.0" 
		 id="bibliography-instance" 
		 src="/editor/forms/mei/model/standard_bibliography.xml" 
		 xxf:readonly="true"/>

    <xf:instance xmlns="http://www.kb.dk/dcm" id="conf"
		 src="/editor/forms/mei/model/settings.xml" />

    <xf:instance id="temp">
      <temp-values>
	<changed>false</changed>
	<change_marker>*</change_marker>
	<etc>...</etc>
	<counter/>
	<max/>
	<music_outline>
	  <exp>0</exp>
	  <comp1>0</comp1>
	  <comp2>0</comp2>
	</music_outline>
      </temp-values>
    </xf:instance>
    
    <!-- submissions - loading and saving data -->

    <!-- test submissions -->
    <!-- load empty instance -->
    <xf:submission id="load-empty-submission"
		   method="get" serialization="none" validate="false"
		   resource="/editor/forms/mei/model/empty_doc.xml"
		   replace="instance" instance="data-instance"/>

    <xf:submission id="load-data-submission" 
		   method="get" 
		   serialization="none" 
		   validate="false"
		   resource="{instance('parameters')/dcm:storage_dir}{instance('parameters')/dcm:xml_file}"
		   replace="instance" instance="data-instance"/>

    <xf:submission id="save-to-file"
		   ref="instance('data-instance')"
		   validate="false"
		   relevant="false"
		   xxf:calculate="false"
		   resource="{instance('parameters')/dcm:storage_dir}{instance('parameters')/dcm:xml_file}" 
		   method="put"
		   replace="instance">
    </xf:submission>
    
    <!-- "onload" xforms actions -->
    <xf:action ev:event="xforms-model-construct-done">
      <!-- store XML data storage server and directory name -->
      <xf:setvalue ref="instance('parameters')/dcm:storage_dir" value="xxf:get-request-parameter('dir')"/>
      <!-- store XML data file name -->
      <xf:setvalue ref="instance('parameters')/dcm:xml_file" value="xxf:get-request-parameter('doc')"/>
      <!-- load XML data -->
      <xf:send submission="load-data-submission"/>
      <!-- automatically add change entry in revisionDesc -->
      <xf:action if="instance('data-instance')/m:meiHead/m:revisionDesc/m:change[last()]/m:date!=''">
	<xf:insert nodeset="instance('data-instance')/m:meiHead/m:revisionDesc/m:change" at="last()"
		   position="after" origin="instance('empty-instance')/m:meiHead/m:revisionDesc/m:change"/>
	<xf:setvalue ref="instance('data-instance')/m:meiHead/m:revisionDesc/m:change[last()]/m:date"
		     value="substring-before(now(), 'T')"/>
      </xf:action>
      <xf:action if="instance('data-instance')/m:meiHead/m:revisionDesc/m:change[last()]/m:date=''">
	<xf:setvalue ref="instance('data-instance')/m:meiHead/m:revisionDesc/m:change[last()]/m:date"
		     value="substring-before(now(), 'T')"/>
      </xf:action>
      <!-- check list of language declarations -->
      <xf:dispatch name="language-update" target="form-group"/>
    </xf:action>
    
    <xf:action ev:event="xforms-submit-done">
      <!-- set instance state to unchanged on saving -->
      <xf:setvalue ref="instance('temp')/changed" value="'false'"/>
    </xf:action>
    
    <xf:action ev:event="xforms-submit-error">
      <xxf:variable name="code" select="event('response-status-code')"/>
      <xf:action if="$code!=404">
	<xf:message>An error occurred (<xf:output value="$code"/>)</xf:message>
      </xf:action>
      <!-- Load empty instance if loading fails (i.e. document does not exist yet) -->
      <xf:action if="$code=404">
	<xf:send submission="load-empty-submission"/>
      </xf:action>
    </xf:action>
    
    <xf:bind nodeset="instance('conf')/dcm:attr" type="xs:boolean"/>
    <xf:bind nodeset="instance('data-instance')//m:instrVoice/@solo" type="xs:boolean"/>
    
  </xf:model>
  
  <!-- XBL components -->
  <xi:include href="includes/element_buttons.xbl" parse="xml"/>
  <!--<xi:include href="includes/attribute_editor.xbl" parse="xml"/>-->
  <xi:include href="includes/dropdown_month_date.xbl" parse="xml"/>
  <xi:include href="includes/date_editor.xbl" parse="xml"/>
  <xi:include href="includes/tei_date_editor.xbl" parse="xml"/>
  <xi:include href="includes/relator.xbl" parse="xml"/>
  <xi:include href="includes/performance_list.xbl" parse="xml"/>
  <xi:include href="includes/expression_input.xbl" parse="xml"/>
  <xi:include href="includes/item.xbl" parse="xml"/>
  <xi:include href="includes/id.xbl" parse="xml"/>
  
</h:head>
