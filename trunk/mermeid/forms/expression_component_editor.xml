<?xml version="1.0" encoding="UTF-8"?>
<h:html xmlns:h="http://www.w3.org/1999/xhtml" 
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
    xmlns:xf="http://www.w3.org/2002/xforms" 
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:oxf="http://www.orbeon.com/oxf/processors"
    xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
    xmlns:ev="http://www.w3.org/2001/xml-events" 
    xmlns:xl="http://www.w3.org/1999/xlink"
    xmlns:xs="http://www.w3.org/2001/XMLSchema" 
    xmlns:m="http://www.music-encoding.org/ns/mei"
    xmlns:t="http://www.tei-c.org/ns/1.0" 
    xmlns:dcm="http://www.kb.dk/dcm">
    
    <!--
        Source data editor 
        Danish Centre for Music Publication (DCM) 
        Axel Teich Geertinger, 2012
        atge@kb.dk
    -->
    
    <h:head>
        
        <h:title id="PageTitle">MerMEId - Editing component metadata</h:title>
        
        <h:meta http-equiv="Content-Type" content="application/xhtml+xml"/>
        
        <h:script type="text/javascript" src="http:/editor/js/editor.js"/>
        
        <h:style type="text/css" media="all"> 
            @import "/editor/style/tab_style.css"; 
            @import "/editor/style/xform_style.css";
            @import "/editor/style/model_editor_style.css";
        </h:style>
        
        <xf:model>
            
            <xf:instance id="data-instance" xmlns="http://www.music-encoding.org/ns/mei">
                <mei/>
            </xf:instance>
            
            <xf:instance id="empty-instance" xmlns="http://www.music-encoding.org/ns/mei">
                <mei/>
            </xf:instance>
            
            <xf:instance id="temp">
                <temp>
                    <id/>
                    <counter/>
                    <changed>false</changed>
                    <change_marker>*</change_marker>
                    <etc>...</etc>
                    <target_uri/>
                    <path/>
                </temp>
            </xf:instance> 
            
            <xf:bind nodeset="instance('temp')">
                <xf:bind id="counter-bind" nodeset="counter" type="xf:integer" name="counter"/>
            </xf:bind>               
            
            <xf:instance id="parameters" xmlns="http://www.kb.dk/dcm">
                <xi:include href="mermeid_configuration.xml" parse="xml"/>
            </xf:instance>
            
            <!-- submissions - loading and saving data -->            
            
            <xf:submission id="load-data-submission" 
                method="get" 
                serialization="none" 
                validate="false"
                resource="{instance('parameters')/dcm:crud_home}{instance('parameters')/dcm:xml_file}"
                replace="instance" instance="data-instance"/>
            
            <xf:submission id="load-empty-submission"
                method="get" 
                serialization="none" 
                validate="false"
                resource="{instance('temp')/target_uri}"
                replace="instance" instance="empty-instance"/>
            
            <xf:submission id="save-to-file"
                ref="instance('data-instance')"
                validate="false"
                relevant="false"
                xxf:calculate="false"
                resource="{instance('parameters')/dcm:crud_home}{instance('parameters')/dcm:xml_file}" 
                method="put"
                replace="instance">
            </xf:submission>
            
            <!-- "onload" xforms actions -->
            <xf:action ev:event="xforms-model-construct-done">
                <!-- store requested ID -->
                <xf:setvalue ref="instance('temp')/id" value="xxf:get-request-parameter('id')"/>
                <!-- store XML data file name -->
                <xf:setvalue ref="instance('parameters')/dcm:xml_file" value="xxf:get-request-parameter('doc')"/>
                <!-- load XML data -->
                <xf:send submission="load-data-submission"/>
                <!-- load empty model XML data -->
                <xf:setvalue ref="instance('temp')/target_uri" value="concat(instance('parameters')/dcm:form_home,'model/empty_doc.xml')"/>
                <xf:send submission="load-empty-submission"/>
                <!-- construct "music component path" -->
                <!-- to do: combine movement numbers, titles, or tempos to identify components -->
                <xf:setvalue ref="instance('temp')/path" 
                    value="string-join(instance('data-instance')//m:expression[descendant-or-self::m:expression/@xml:id=instance('temp')/id]//m:title,'/')"/>
            </xf:action>
            
            <xf:action ev:event="xforms-submit-done">
                <!-- set instance state to unchanged on saving -->
                <xf:setvalue ref="instance('temp')/changed" value="'false'"/>
            </xf:action>
            
            <xf:action ev:event="xforms-submit-error">
                <xxf:variable name="code" select="event('response-status-code')"/>
                <xf:action>
                    <xf:message>An error occurred (<xf:output value="$code"/>)</xf:message>
                </xf:action>
            </xf:action>
            
        </xf:model>
        
        <!-- XBL components -->
        <xi:include href="includes/element_buttons.xbl" parse="xml"/>
        <xi:include href="includes/dropdown_month_date.xbl" parse="xml"/>
        <xi:include href="includes/date_editor.xbl" parse="xml"/>
        <xi:include href="includes/relator.xbl" parse="xml"/>
        <xi:include href="includes/item.xbl" parse="xml"/>
        <xi:include href="includes/id.xbl" parse="xml"/>
        
    </h:head>
    
    <h:body class="music">
        
        <h:div class="inputdiv">
            
            <h:div style="float:right">
                <xf:submit submission="save-to-file">
                    <xf:label>Save</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xxf:variable name="uri" select="concat(instance('parameters')/dcm:edit-music,instance('parameters')/dcm:xml_file)"/>
                        <xf:load resource="{$uri}" show="replace"/>
                    </xf:action>
                </xf:submit>
                <xf:trigger>
                    <xf:label>Cancel</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xxf:variable name="uri" select="concat(instance('parameters')/dcm:edit-music,instance('parameters')/dcm:xml_file)"/>
                        <xf:load resource="{$uri}" show="replace"/>
                    </xf:action>
                </xf:trigger>
            </h:div>
            
            <xf:group ref="instance('data-instance')//m:expression[@xml:id=instance('temp')/id]">
                <xxf:variable name="num_ex" as="string">
                    <xxf:sequence select="count(../m:expression)"/>
                </xxf:variable>
                <xxf:variable name="is_component" as="string">
                    <xxf:sequence select="if (local-name(..)='componentGrp') then 'true' else 'false'"/>
                </xxf:variable>
                <xxf:variable name="binding" select="."/>
                
                
                <h:h3>
                    Component 
                    <!-- "path" to be shown here -->
                    <!--<xf:output value="instance('temp')/path"/>-->
                    <dcm:id ref="."/>
                </h:h3>                
                
                
                <h:fieldset>
                    <h:legend>Component</h:legend>
                    <!-- display expression-specific details at top level only if more than one expression or not empty -->
                    <xf:group ref=".[$is_component='true' or number($num_ex)&gt;1 or m:titleStmt/m:title[normalize-space(.)!='']]">
                        <h:div class="blocklabel" style="margin-top:10px">
                            <xf:group ref=".[$is_component='false']">Version title</xf:group>
                            <xf:group ref=".[$is_component='true']">Component title</xf:group>
                            <xf:group ref=".[$is_component='false']">
                                <h:a class="help">?<h:span class="comment">E.g. "Version for piano" or 
                                    "Discarded version". Enter a version title only if you 
                                    want to distinguish different versions of the work. 
                                    Otherwise leave empty.</h:span></h:a>
                            </xf:group>
                            <xf:group ref=".[$is_component='true']">
                                <h:a class="help">?<h:span class="comment">Optional. Any title for this component 
                                    other than a movement number or tempo; e.g. "Act 1", "Scene 2", 
                                    "Introduzione" or "Des Baches Wiegenlied"</h:span></h:a>
                            </xf:group>
                            <h:a class="help_plain"><h:img src="http:/editor/images/html_markup.gif" 
                                alt="HTML markup allowed"/><h:span class="comment">HTML markup and special characters allowed</h:span></h:a>
                        </h:div>
                        <xf:group ref="m:titleStmt">
                            <xf:repeat nodeset="m:title" id="repeat-version-titles" class="input_group">
                                <h:div>
                                    <xf:group ref=".[$is_component='false' and number($num_ex)=1 and .!='']">
                                        <h:a class="help_plain"><h:img src="http:/editor/images/warning.png" 
                                            alt="warning"/><h:span class="comment">
                                                When only one version is given, 
                                                no title should be entered at this level. <h:br/>
                                                If no alternative versions are added, please indicate the 
                                                title at work level (i.e., the "Work" tab) instead.
                                            </h:span></h:a>
                                    </xf:group>
                                    <xi:include href="includes/input_with_xmllang.xml" parse="xml"/>
                                    <dcm:element-buttons 
                                        triggers="all" 
                                        nodeset="m:title" 
                                        index="repeat-version-titles"
                                        origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:titleStmt/m:title"/>
                                </h:div>
                            </xf:repeat>
                        </xf:group>                                    
                        <xf:group ref=".[$is_component='true' or @n!='']">
                            <!-- use numbering with components only -->
                            <xf:group ref=".[$is_component='false']">
                                <h:a class="help_plain"><h:img src="http:/editor/images/warning.png" 
                                    alt="warning"/><h:span class="comment">
                                        Normally, movement numbers should only be be entered 
                                        at component level.<h:br/>
                                        Please consider moving this number to the component level
                                        below or deleting it.
                                    </h:span></h:a>
                            </xf:group>
                            <xf:input ref="@n" class="short">
                                <xf:label>No. <h:a class="help">?<h:span 
                                    class="comment">Movement, section or scene numbers may be entered either here 
                                    or as part of the title above</h:span></h:a></xf:label>
                            </xf:input> 
                        </xf:group>
                    </xf:group>
                    
                    <h:div>                               
                        <xf:input ref="m:tempo" class="maxlong">
                            <xf:label class="fixed_width_short">Tempo</xf:label>
                        </xf:input>
                        <h:br clear="all"/>  
                        <xf:input ref="m:meter/@meter.count" class="minimal_length">
                            <xf:label class="fixed_width_short">Metre</xf:label>
                        </xf:input>/ <xf:input ref="m:meter/@meter.unit" class="minimal_length"/> or symbol: 
                        <xf:select1	ref="m:meter/@meter.sym" class="auto_length">
                            <xf:item>
                                <xf:label>-</xf:label>
                                <xf:value/>
                            </xf:item>
                            <xf:item>
                                <xf:label>common time</xf:label>
                                <xf:value>common</xf:value>
                            </xf:item>
                            <xf:item>
                                <xf:label>cut time</xf:label>
                                <xf:value>cut</xf:value>
                            </xf:item>
                        </xf:select1>
                    </h:div>                                    
                    <xf:group ref="m:key">
                        <h:span class="fixed_width_short">Key</h:span>
                        <xi:include href="includes/key_select.xml" parse="xml"/>
                    </xf:group>
                    <h:br clear="all"/>
                    <h:span class="blocklabel">Music incipit graphics</h:span>
                    <xf:repeat nodeset="m:incip/m:graphic" id="incipit-repeat">
                        <h:div>
                            <xf:input ref="@target" class="maxlong">
                                <xf:label>URI <h:a class="help">?<h:span class="comment">Location of a graphics file, e.g.
                                    "http://example.com/incipits/lowres/116.png"</h:span></h:a></xf:label>
                            </xf:input>
                            <xf:select1 ref="@targettype" class="auto_length">
                                <xf:item>
                                    <xf:value>lowres</xf:value>
                                    <xf:label>Low resolution</xf:label>
                                </xf:item>
                                <xf:item>
                                    <xf:value>hires</xf:value>
                                    <xf:label>High resolution</xf:label>
                                </xf:item>
                                <xf:item>
                                    <xf:value>print</xf:value>
                                    <xf:label>Print quality</xf:label>
                                </xf:item>
                            </xf:select1>
                            <h:a class="help">?<h:span class="comment">Choose "Low resolution" for standard web graphics, "High resolution" for high quality
                                web graphics, or "Print quality" for print quality graphics</h:span></h:a>
                            <dcm:element-buttons
                                triggers="add delete" 
                                nodeset="m:graphic" 
                                index="incipit-repeat"
                                origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:incip/m:graphics[1]"/>
                        </h:div>
                    </xf:repeat>
                    <h:span class="blocklabel">Text incipit
                        <h:a class="help_plain"><h:img src="http:/editor/images/html_markup.gif" alt="HTML markup allowed"/><h:span class="comment">HTML markup and special characters allowed</h:span></h:a>
                    </h:span>
                    <xf:repeat nodeset="m:incip/m:incipText/m:p" id="text-incipit-repeat" class="input_group">
                        <xi:include href="includes/input_with_xmllang.xml" parse="xml"/>
                        <dcm:element-buttons
                            triggers="add delete" 
                            nodeset="m:p" 
                            index="text-incipit-repeat"
                            origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:incip/m:incipText/m:p"/>
                        <h:br/>
                    </xf:repeat>
                    <h:span class="blocklabel">Edited score</h:span>
                    <xf:repeat nodeset="m:relationList/m:relation[@rel='hasReproduction' and @targettype='edited_score']" id="edited_score-repeat">
                        <h:div>
                            <xf:input ref="@target" class="long">
                                <xf:label>URI <h:a class="help">?<h:span class="comment">Location of an external, edited score (this movement only).
                                    Not for digital representations of items listed as "Sources"</h:span></h:a></xf:label>
                            </xf:input>
                            <xf:input ref="@label">
                                <xf:label>Description <h:a class="help">?<h:span class="comment">Explanatory text for the link to the resource, 
                                    e.g. "Carl Nielsen Edition, full score"</h:span></h:a></xf:label>
                            </xf:input>
                            <dcm:element-buttons
                                triggers="add delete" 
                                nodeset="m:relation" 
                                index="edited_score-repeat"
                                origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:relationList/m:relation[@rel='hasReproduction' and @targettype='edited_score']"/>
                        </h:div>
                    </xf:repeat>
                    <h:br/> 
                    
                    <xf:group ref="m:titleStmt">
                        <h:div class="blocklabel strong">Persons <h:a class="help">?<h:span 
                            class="comment">Persons with connection to this particular 
                            <xf:group ref=".[$is_component='false']">version</xf:group>
                            <xf:group ref=".[$is_component='true']">component</xf:group>
                            only, e.g. an arranger, or a text author in a collection of songs 
                            with different authors</h:span></h:a></h:div>	
                        <h:div class="blocklabel">
                            <h:span class="fixed_width_long">Name</h:span>
                            <h:span> Relation <h:a class="help">?<h:span class="comment">Specifies the person's relation to the item, e.g. "Arranger"
                                or "Author". The list is based on MARC relators as defined at http://id.loc.gov/vocabulary/relators</h:span></h:a>
                            </h:span>
                        </h:div>
                        <xf:repeat nodeset="m:respStmt/m:persName" id="version-relators-repeat">
                            <dcm:relator ref="."/>
                            <dcm:element-buttons 
                                triggers="add delete" 
                                nodeset="m:persName" 
                                index="version-relators-repeat"
                                origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:titleStmt/m:respStmt/m:persName[1]"/>
                            <h:br/>
                        </xf:repeat>
                    </xf:group>
                    
                    <!-- Instrumentation editable at top level only (or if not empty) -->
                    <!-- Remove the group condition to enable instrumentation editing at component levels -->
                    <xf:group ref=".[$is_component='false' or //m:instrVoice[.!='']]">
                        <h:hr/>                                                     
                        <h:label class="blocklabel strong">Instrumentation, singers and characters <h:a class="help">?<h:span 
                            class="comment">Instruments and singers may be grouped into ensembles or specified
                            as "stand-alone" performers. A group of performers acting as an ensemble (including choirs)
                            should be defined as such. Each ensemble may or may not have a name (label) for display, 
                            and may or may not list its individual performers.<h:br/>
                            Both ensembles and performers should have a MARC standard code added to improve
                            data compatibility and interchange. Codes are selected from the dropdown menus.							
                        </h:span></h:a>
                            <xf:trigger id="id-trigger" appearance="minimal">
                                <xf:label></xf:label>
                                <xf:action ev:event="DOMActivate add-id">
                                    <!-- add @xml:id and value to ensembles and performers without it -->
                                    <xf:setvalue ref="instance('temp')/counter" value="0" />
                                    <xf:setvalue ref="instance('temp')/max" value="count($binding//*[local-name()='ensemble' or local-name()='performer'][count(@xml:id)=0])"/>
                                    <xf:action while="(instance('temp')/max) - (instance('temp')/counter) &gt; 0">
                                        <xf:setvalue ref="instance('temp')/counter" value=". + 1" />
                                        <xf:setvalue ref="instance('temp')/attributes/@xml:id"
                                            value="concat(local-name(..),'_id',substring(digest(string(random(true)), 'MD5', 'hex'),1,8))"/>  
                                        <xf:insert context="$binding//*[local-name()='ensemble' or local-name()='performer'][count(@xml:id)=0][instance('temp')/counter]" 
                                            origin="instance('temp')/attributes/@xml:id"/>
                                    </xf:action>
                                    <xf:dispatch name="id-update" target="form-group"/>
                                </xf:action>
                            </xf:trigger>
                            
                        </h:label>
                        
                        <xf:group ref="m:perfMedium">
                            <h:div class="blocklabel strong">Ensembles 
                                <xf:trigger ref=".[count($binding/m:perfMedium/m:ensemble)=0]">
                                    <xf:label><img src="http:/editor/images/list.png" alt="Add from list"/> Add ensemble</xf:label>
                                    <xf:action ev:event="DOMActivate">
                                        <xxf:show dialog="ensemble-menu"/>
                                    </xf:action>
                                </xf:trigger>
                                <!-- dialog for adding ensembles -->
                                <xxf:dialog id="ensemble-menu" appearance="full" level="modal"
                                    close="true" draggable="true" visible="false">
                                    <xf:label>Ensembles</xf:label>
                                    <xf:repeat nodeset="instance('instrumentation')/m:ensemble[m:instrVoice/@reg]" id="ensemble-menu-repeat">
                                        <xf:trigger submission="replace-form-with" appearance="minimal">
                                            <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/>
                                                <xf:output ref="if (m:instrVoice!='') then m:instrVoice else '[empty ensemble]'"/>
                                            </xf:label>
                                            <xf:action ev:event="DOMActivate">
                                                <xf:insert context="$binding/m:perfMedium" 
                                                    nodeset="m:ensemble"
                                                    at="index('repeat-ensemble')"
                                                    position="after" 
                                                    origin="instance('instrumentation')/m:ensemble[m:instrVoice/@reg][index('ensemble-menu-repeat')]"/>
                                                <!-- generate IDs for added performers -->
                                                <xf:dispatch name="add-id" target="id-trigger"/>
                                                <xxf:hide dialog="ensemble-menu"/>
                                            </xf:action>
                                        </xf:trigger>
                                        <h:br/>
                                    </xf:repeat>
                                </xxf:dialog>			
                            </h:div>
                            <xf:repeat nodeset="m:ensemble" id="repeat-ensemble">
                                <h:fieldset>
                                    <h:legend>
                                        <xf:output value="if (m:instrVoice!='') then m:instrVoice else '[Ensemble]'"/>
                                        <dcm:element-buttons 
                                            triggers="up down" 
                                            nodeset="m:ensemble" 
                                            origin="instance('instrumentation')/m:ensemble[m:instrVoice/@reg][index('ensemble-menu-repeat')]"
                                            index="repeat-ensemble"/><xf:trigger 
                                                appearance="minimal" class="non-standard_button">
                                                <xf:label><img src="http:/editor/images/add.gif" alt="Add" title="Add row"/></xf:label>
                                                <xf:action ev:event="DOMActivate">
                                                    <xxf:show dialog="ensemble-menu"/>
                                                </xf:action>
                                            </xf:trigger>
                                        <xf:trigger appearance="minimal">
                                            <xf:label><h:img src="http:/editor/images/remove.gif" alt="Delete" title="Delete row"/></xf:label>
                                            <xf:action ev:event="DOMActivate">
                                                <xf:delete nodeset="." at="index('repeat-ensemble')"/>
                                                <!-- remove references to deleted items -->
                                                <xf:setvalue ref="$binding/m:castList/m:castItem/m:role/m:ref/@target[not(.=$binding//@xml:id)]" value="''"/>
                                            </xf:action>
                                        </xf:trigger>
                                    </h:legend>
                                    <h:div class="vertical_spacer"/> 
                                    <h:div>
                                        <xf:input ref="m:instrVoice" class="mediumlong">
                                            <xf:label class="fixed_width">Name <h:a class="help">?<h:span 
                                                class="comment">Optional. Use if you want 
                                                to specify the type of ensemble, e.g. "Orchestra", "String quartet", 
                                                or "Choir". If no ensemble name has been entered in the first field, 
                                                a suggested name is automatically inserted when choosing
                                                a standard ensemble code in the last field.
                                            </h:span></h:a></xf:label>
                                        </xf:input>
                                        <xf:select1 ref="m:instrVoice/@reg">
                                            <xf:label>Standard code <h:a class="help">?<h:span 
                                                class="comment">Choosing a standard MARC code optimizes data  
                                                compatibility and interchangeability with other systems. <h:br/>
                                                A code should be supplied also when you do not want the ensemble 
                                                to have a name (label).
                                            </h:span></h:a></xf:label>
                                            <xf:itemset nodeset="instance('ensembles')//m:ensemble">
                                                <xf:label><xf:output value="if (m:instrVoice/@reg!='') then concat(m:instrVoice/@reg, ' (',m:instrVoice,')') else '- Please select -'"/></xf:label>
                                                <xf:value ref="m:instrVoice/@reg"/>
                                            </xf:itemset>
                                            <xf:action ev:event="xforms-value-changed">
                                                <xxf:variable name="ensemble" select="."></xxf:variable>
                                                <xf:action if="..=''">
                                                    <!-- set ensemble name if empty -->
                                                    <xf:setvalue ref=".." value="instance('ensembles')//m:ensemble/m:instrVoice[@reg=$ensemble]"/>
                                                </xf:action>
                                            </xf:action>
                                        </xf:select1>
                                    </h:div>
                                    <!-- performers within an ensemble -->
                                    <h:div><h:span class="fixed_width">Performers 
                                        <h:a class="help">?<h:span class="comment">Optional. An ensemble may be specified by name (above), 
                                            by a list of performers, or both.</h:span></h:a></h:span>
                                        <!-- dialog for adding performers to existing ensembles -->
                                        <xxf:dialog id="ensemble-performer-menu" appearance="full" level="modal"
                                            close="true" draggable="true" visible="false">
                                            <xf:label>Performers</xf:label>
                                            <xf:repeat nodeset="instance('instrumentation')/m:ensemble[m:performer]" id="ensemble-performer-menu-repeat">
                                                <xf:trigger submission="replace-form-with" appearance="minimal">
                                                    <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/>
                                                        <xf:output ref="if (m:instrVoice!='') then m:instrVoice else '[single performer]'"/>
                                                    </xf:label>
                                                    <xf:action ev:event="DOMActivate">
                                                        <xf:insert context="$binding/m:perfMedium/m:ensemble[index('repeat-ensemble')]" 
                                                            nodeset="m:performer"
                                                            at="index('repeat-ensemble-performer')"
                                                            position="after" 
                                                            origin="instance('instrumentation')/m:ensemble[m:performer][index('ensemble-performer-menu-repeat')]/m:performer"/>
                                                        <!-- generate IDs for added performers -->
                                                        <xf:dispatch name="add-id" target="id-trigger"/>
                                                        <xxf:hide dialog="ensemble-performer-menu"/>
                                                    </xf:action>
                                                </xf:trigger>
                                                <h:br/>
                                            </xf:repeat>
                                        </xxf:dialog>			
                                        <xf:trigger ref=".[count(m:performer)=0]" style="margin-left: 8px;">
                                            <xf:label><img src="http:/editor/images/list.png" alt="Add from list"/> Add performer(s)</xf:label>
                                            <xf:action ev:event="DOMActivate">
                                                <xxf:show dialog="ensemble-performer-menu"/>
                                            </xf:action>
                                        </xf:trigger>
                                    </h:div>
                                    <h:div class="vertical_spacer"/> 
                                    <h:span class="fixed_width_mediumlong">No. &amp; name <h:a class="help">?<h:span 
                                        class="comment">Enter the number of players in the 
                                        first input field, and the instrument's name, as it is to be 
                                        displayed, in the second, e.g. "vl.1" or "violin".
                                        If no name is entered, a suggested name is inserted when 
                                        choosing a standard instrument code in the last field.
                                    </h:span></h:a></h:span>
                                    <h:span class="fixed_width_long">Standard code <h:a class="help">?<h:span 
                                        class="comment">Choosing a standard MARC code optimizes data  
                                        compatibility and interchangeability with other systems.<h:br/>
                                        Also, it may be used to automatically insert the 
                                        instrument's name in the "name" field if no name has been entered yet.
                                    </h:span></h:a></h:span>
                                    <h:br/>
                                    <xf:repeat nodeset="m:performer" id="repeat-ensemble-performer">
                                        <xi:include href="includes/instrvoice-input.xml" parse="xml"/>
                                        <dcm:element-buttons
                                            triggers="up down add" 
                                            nodeset="m:performer" 
                                            origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:perfMedium/m:performer[1]"
                                            index="repeat-ensemble-performer"/>
                                        <xf:trigger appearance="minimal" class="non-standard_button">
                                            <xf:label><h:img src="http:/editor/images/remove.gif" alt="Delete" title="Delete row"/></xf:label>
                                            <xf:action ev:event="DOMActivate">
                                                <xf:delete nodeset="." at="index('repeat-ensemble-performer')"/>
                                                <!-- remove references to deleted items -->
                                                <xf:setvalue ref="$binding/m:castList/m:castItem/m:role/m:ref/@target[not(.=$binding//@xml:id)]" value="''"/>
                                                <xf:dispatch name="xforms-value-changed" target="form-group"/>
                                            </xf:action>
                                        </xf:trigger>
                                        <xf:trigger>
                                            <xf:label><img src="http:/editor/images/list.png" alt="Add" title="Add from list"/> Add from list</xf:label>
                                            <xf:action ev:event="DOMActivate">
                                                <xxf:show dialog="ensemble-performer-menu"/>
                                            </xf:action>
                                        </xf:trigger>                                            
                                        <h:br/>
                                    </xf:repeat>
                                </h:fieldset>
                            </xf:repeat>
                            
                            <!-- stand-alone performers -->
                            <h:div class="blocklabel strong">Instruments and singers
                                <h:a class="help">?<h:span class="comment">List of performers not to be regarded 
                                    as part of an ensemble. Use this section for some chamber music
                                    (e.g. piano music, songs with or without piano, music for solo instruments)
                                    and for soloists (vocalists and instrumentalists). 
                                </h:span></h:a>
                            </h:div>
                            <xf:trigger ref=".[count(m:performer)=0]">
                                <xf:label><img src="http:/editor/images/add.gif" alt="Add"/> Add performer</xf:label>
                                <xf:action ev:event="DOMActivate">
                                    <xf:insert context="." 
                                        origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:perfMedium/m:performer[1]"/>
                                    <xf:dispatch name="add-id" target="id-trigger"/>
                                </xf:action>
                            </xf:trigger>
                            <xf:group ref=".[count(m:performer)&gt;0]">
                                <h:div class="vertical_spacer"/> 
                                <h:span class="fixed_width_mediumlong">No. &amp; name <h:a class="help">?<h:span 
                                    class="comment">Enter the number of players in the 
                                    first input field, and the instrument's name, as it is to be 
                                    displayed, in the second, e.g. "vl.1" or "violin".
                                    If no name is entered, a suggested name is inserted when 
                                    choosing a standard instrument code in the last field.
                                </h:span></h:a></h:span>
                                <h:span class="fixed_width_long">Standard code <h:a class="help">?<h:span 
                                    class="comment">Choosing a standard MARC code optimizes data  
                                    compatibility and interchangeability with other systems.<h:br/>
                                    Also, it may be used to automatically insert the 
                                    instrument's name in the "name" field if no name has been entered yet.
                                </h:span></h:a></h:span>
                                <h:span class="fixed_width_short" style="text-align:center;">Solo <h:a class="help">?<h:span 
                                    class="comment">Mark performers as soloists only when they are to be 
                                    regarded as soloists as opposed to an ensemble.<h:br/> 
                                    "Solo" should usually not be used with chamber music or 
                                    music for one instrument.</h:span></h:a></h:span>
                                <h:br/>
                                <xf:repeat nodeset="m:performer" id="repeat-performer">
                                    <xi:include href="includes/instrvoice-input.xml" parse="xml"/>
                                    <h:span class="fixed_width_short"  style="text-align:center;">
                                        <xf:input ref="m:instrVoice/@solo"><xf:label> </xf:label></xf:input>
                                    </h:span>
                                    <dcm:element-buttons
                                        triggers="add up down copy" 
                                        nodeset="m:performer" 
                                        origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:perfMedium/m:performer[1]"
                                        index="repeat-performer"/><xf:trigger 
                                            appearance="minimal" class="element-button">
                                            <xf:label><h:img src="http:/editor/images/remove.gif" alt="Delete" title="Delete row"/></xf:label>
                                            <xf:action ev:event="DOMActivate">
                                                <xf:delete nodeset="." at="index('repeat-performer')"/>
                                                <!-- remove references to deleted items -->
                                                <xf:setvalue ref="$binding/m:castList/m:castItem/m:role/m:ref/@target[not(.=$binding//@xml:id)]" value="''"/>
                                                <xf:dispatch name="xforms-value-changed" target="form-group"/>
                                            </xf:action>
                                        </xf:trigger>
                                    <h:br/>
                                </xf:repeat>
                            </xf:group>
                        </xf:group>
                        
                        <xf:group ref="m:castList">
                            <h:div class="blocklabel strong">Characters
                                <h:a class="help">?<h:span class="comment">A list of characters 
                                    appearing in the piece. Names may be entered in more than one language, and each 
                                    characters may be linked to a performer listed above.                                        
                                </h:span></h:a>                                        
                            </h:div>
                            <xf:trigger ref=".[count(m:castItem)=0]">
                                <xf:label><img src="http:/editor/images/add.gif" alt="Add"/> Add character</xf:label>
                                <xf:action ev:event="DOMActivate">
                                    <xf:insert context="." 
                                        origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:castList/m:castItem[1]"/>
                                    <xf:setvalue ref="m:castItem[last()]/@xml:id"
                                        value="concat('castItem_id',substring(digest(string(random(true)), 'MD5', 'hex'),1,8))"/>
                                    <xf:dispatch name="id-update" target="form-group"/>
                                </xf:action>
                            </xf:trigger>
                            <xf:repeat nodeset="m:castItem" id="repeat-cast">
                                <xf:action ev:event="xforms-value-changed">
                                    <xf:dispatch name="add-id" target="main-group"/>
                                </xf:action>
                                <h:fieldset>
                                    <h:legend>
                                        <xf:output value="if (m:role/m:ref/m:name[1]!='') then m:role/m:ref/m:name[1] else '[Character]'"/>
                                        <dcm:element-buttons
                                            triggers="add remove up down" 
                                            nodeset="m:castItem" 
                                            index="repeat-cast"
                                            origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:castList/m:castItem[1]"/>
                                    </h:legend>
                                    <xf:repeat nodeset="m:role/m:ref/m:name" id="repeat-role">
                                        <xxf:variable name="pos" select="position()"/>
                                        <xf:input ref="."><xf:label class="fixed_width">Name: <h:a class="help">?<h:span
                                            class="comment">E.g. "Erik", "A servant" or "Villagers"</h:span></h:a></xf:label></xf:input>
                                        <xf:input ref="../../../m:roleDesc[$pos]"><xf:label> Description: <h:a class="help">?<h:span
                                            class="comment">An optional description of the role, e.g. 
                                            "King of Denmark" or "Rigoletto's daughter"</h:span></h:a></xf:label></xf:input>
                                        <xf:select1 ref="@xml:lang" xxf:refresh-items="false">
                                            <xf:label/>
                                            <xf:itemset nodeset="instance('languages')/language">
                                                <xf:label><xf:output value="."/></xf:label>
                                                <xf:value ref="@xml:id"></xf:value>
                                            </xf:itemset>
                                            <xf:action ev:event="xforms-value-changed">
                                                <xxf:variable name="lang" select="."/>
                                                <xf:setvalue ref="$binding/m:castList/m:castItem[index('repeat-cast')]/m:roleDesc[$pos]/@xml:lang" value="$lang"/>
                                            </xf:action>
                                        </xf:select1>
                                        <!-- edit buttons --> 
                                        <h:span class="editmenu" style="margin-left: 8px;">
                                            <xf:trigger appearance="minimal" class="element-button">
                                                <xf:label><h:img src="http:/editor/images/add.gif" alt="Add" title="Add row"/></xf:label>
                                                <xf:action ev:event="DOMActivate">
                                                    <xf:insert context="parent::node()" nodeset="m:name[index('repeat-role')]"
                                                        origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:castList/m:castItem[1]/m:role/m:ref/m:name"/>
                                                    <xf:insert context="../../.." nodeset="m:roleDesc[index('repeat-role')]"
                                                        origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:expressionList/m:expression[1]/m:castList/m:castItem[1]/m:roleDesc"/>
                                                    <xf:dispatch name="id-update" target="form-group"/>
                                                </xf:action>
                                            </xf:trigger>
                                            <xf:trigger appearance="minimal" class="element-button">
                                                <xf:label><h:img src="http:/editor/images/remove.gif" alt="Delete" title="Delete row"/></xf:label>
                                                <xf:delete ev:event="DOMActivate" nodeset="../m:name" at="index('repeat-role')"/>
                                                <xf:delete ev:event="DOMActivate" nodeset="../../../m:roleDesc" at="index('repeat-role')"/>
                                                <xf:dispatch name="xforms-value-changed" target="form-group"/>
                                            </xf:trigger>
                                        </h:span>
                                        <!-- end buttons -->
                                        <h:br/>
                                    </xf:repeat>
                                    <xf:select1 ref="m:role/m:ref/@target" xxf:refresh-items="true" id="cast-select">
                                        <xf:label class="fixed_width">Performed by: 
                                            <h:a class="help">?<h:span class="comment">To specify the vocalist(s) performing
                                                this character, select the appropriate performer or ensemble from the list.<h:br/>
                                                Use this to indicate that, for instance, King Erik is sung by a tenor soloist.
                                            </h:span></h:a>
                                        </xf:label>
                                        <xf:item>
                                            <xf:label>- Please select -</xf:label>
                                            <xf:value/>
                                        </xf:item>
                                        <xf:itemset nodeset="$binding//*[(local-name()='ensemble' or local-name()='performer') and local-name(..)='perfMedium'][m:instrVoice!='']">
                                            <!-- last AND condition excludes performers within an ensemble from the drop-down list-->
                                            <xf:label><xf:output value="m:instrVoice"/></xf:label>
                                            <xf:value ref="@xml:id"></xf:value>
                                        </xf:itemset>
                                    </xf:select1>
                                    <h:br/>
                                    
                                </h:fieldset>
                            </xf:repeat>
                        </xf:group>
                        
                        
                    </xf:group>
                </h:fieldset>                        
                
                
            </xf:group>
            
        </h:div>
        
        <h:br clear="all"/>        
        <xi:include href="edit-form-footer.xml" parse="xml"/>
        
    </h:body>
</h:html>
