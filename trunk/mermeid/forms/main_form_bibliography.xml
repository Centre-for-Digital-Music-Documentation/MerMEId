<?xml version="1.0" encoding="UTF-8" ?>
<h:div id="bibliography-div" 
  xmlns:m="http://www.music-encoding.org/ns/mei" 
  xmlns:xi="http://www.w3.org/2001/XInclude" 
  xmlns:t="http://www.tei-c.org/ns/1.0"
  xmlns:h="http://www.w3.org/1999/xhtml" 
  xmlns:xf="http://www.w3.org/2002/xforms" 
  xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
  xmlns:ev="http://www.w3.org/2001/xml-events"
  xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
  xmlns:dcm="http://www.kb.dk/dcm">
  
  <h:div class="inputdiv">
    
    <xf:group ref="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']">
      
      <!-- reference types menu -->
      <xxf:dialog id="add-ref-dialog" appearance="full" level="modal"
        close="true" draggable="true" visible="false">
        <h:div class="blocklabel">Add new reference:</h:div>
        <h:br clear="all"/>
        <xf:repeat nodeset="instance('bibl-type-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]/@type]/t:bibl" 
          id="ref-type-menu-repeat">
          <xf:output value="concat('listbibltype: ',instance('data-instance')/m:music/m:front/t:div/t:listBibl[index('repeat-listbibl')]/@type"/>
          <xf:trigger submission="replace-form-with" appearance="minimal" class="non-standard_trigger">
            <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/> <xf:output ref="translate(@type,'_',' ')"/></xf:label>
            <xf:action ev:event="DOMActivate">
              <xf:toggle case="hide_ref_types"/>
              <xf:insert context="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]" 
                nodeset="t:bibl" 
                at="index('repeat-references')"
                position="after" 
                origin="instance('bibl-type-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]/@type]/t:bibl[index('ref-type-menu-repeat')]"/>
              <xf:dispatch name="id-update" target="form-group"/>
              <xxf:hide dialog="add-ref-dialog"/>
            </xf:action>
          </xf:trigger>
          <h:br clear="all"/>
        </xf:repeat>
        <xf:repeat nodeset="instance('bibl-type-instance')/t:listBibl[not(@type)]/t:bibl" id="ref-type-menu-repeat2">
          <xf:output value="concat('listbibltype: ',instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]/@type"/>
          <xf:trigger submission="replace-form-with" appearance="minimal">
            <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/> <xf:output ref="translate(@type,'_',' ')"/></xf:label>
            <xf:action ev:event="DOMActivate">
              <xf:toggle case="hide_ref_types"/>
              <xf:insert context="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]" 
                nodeset="t:bibl" 
                at="index('repeat-references')"
                position="after" 
                origin="instance('bibl-type-instance')/t:listBibl[not(@type)]/t:bibl[index('ref-type-menu-repeat2')]"/>
              <xf:dispatch name="id-update" target="form-group"/>
              <xxf:hide dialog="add-ref-dialog"/>
            </xf:action>
          </xf:trigger>
          <h:br clear="all"/>
        </xf:repeat>
        <!-- standard references quick-add menu -->
        <xf:group ref=".[count(instance('bibliography-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:seriesStmt/m:seriesStmt[@label='File collection']/m:identifier])&gt;0]">
          <h:hr style="margin:10px 0px;"/>
          <h:div class="blocklabel">Add from this collections's standard references:</h:div>
          <h:br clear="all"/>
          <xf:repeat nodeset="instance('bibliography-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:seriesStmt/m:seriesStmt[@label='File collection']/m:identifier]" id="std-bibl-repeat">
            <xf:repeat nodeset="t:bibl" id="std-bibl-menu-repeat">
              <xf:trigger submission="replace-form-with" appearance="minimal">
                <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/> <xf:output ref="t:abbr"/></xf:label>
                <xf:action ev:event="DOMActivate">
                  <xf:insert context="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[index('repeat-listbibl')]"
                    nodeset="t:bibl"
                    at="index('repeat-references')" 
                    position="after" 
                    origin="instance('bibliography-instance')/t:listBibl[@type=instance('data-instance')/m:meiHead/m:fileDesc/m:seriesStmt/m:seriesStmt[@label='File collection']/m:identifier][index('std-bibl-repeat')]/t:bibl[index('std-bibl-menu-repeat')]"/>
                  <xf:dispatch name="id-update" target="form-group"/>
                  <xxf:hide dialog="add-ref-dialog"/>
                </xf:action>
              </xf:trigger>
              <h:br clear="all"/>
            </xf:repeat>
          </xf:repeat>
        </xf:group>
      </xxf:dialog>
      <!-- end menu -->
      
      <h:br/>
      
      <!-- trigger adding a primary bibliography -->
      <xf:trigger ref=".[not(t:listBibl[@type='primary'])]/t:listBibl">
        <xf:label> Add a primary bibliography</xf:label>
        <xf:action ev:event="DOMActivate">
          <xf:insert nodeset="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl" at="1" position="before"
            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[@type='primary']"/>
          <xf:dispatch name="id-update" target="form-group"/>
        </xf:action>
      </xf:trigger>
      
      <!-- trigger adding a secondary bibliography -->
      <xf:trigger ref="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography'][not(t:listBibl[@type='secondary'])]/t:listBibl">
        <xf:label> Add a secondary bibliography</xf:label>
        <xf:action ev:event="DOMActivate">
          <xf:insert nodeset="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl" at="1" position="after"
            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[@type='secondary']"/>
          <xf:dispatch name="id-update" target="form-group"/>
        </xf:action>
      </xf:trigger>
      
      <!-- trigger adding a section for documentary material -->
      <xf:trigger ref="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography'][not(t:listBibl[@type='documentation'])]/t:listBibl">
        <xf:label> Add documentary material</xf:label>
        <xf:action ev:event="DOMActivate">
          <xf:insert nodeset="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl" at="last()" position="after"
            origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[@type='documentation']"/>
          <xf:dispatch name="id-update" target="form-group"/>
        </xf:action>
      </xf:trigger>
      
      
      <xf:repeat nodeset="t:listBibl" id="repeat-listbibl">
        <h:fieldset>
          <h:legend>
            <xf:output value="concat(translate(substring(@type,1,1),'abcdefghijklmnopqrstuvwxyz','ABCDEFGHIJKLMNOPQRSTUVWXYZ'),substring(@type,2,string-length(@type)-1))"/> 
            <xf:output ref=".[count(@type)&lt;1]" value="'Bibliography'"/>
            <dcm:element-buttons triggers="remove" 
              nodeset="t:listBibl" 
              origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[1]" 
              index="repeat-listbibl"/>
          </h:legend>
          <h:br/>
          <h:span class="blocklabel strong">References</h:span>
          <xf:trigger ref=".[not(t:bibl)]">
            <xf:label> Add reference</xf:label>
            <xf:action ev:event="DOMActivate">
              <xxf:show dialog="add-ref-dialog"/>
            </xf:action>
          </xf:trigger>
          <h:table class="element_list" cellspacing="0" cellpadding="0" border="0">
            <xf:repeat nodeset="t:bibl" id="repeat-references">
              <h:tr class="hoverclass">
                <h:td class="number_cell">
                  <xf:output value="position()"/>&#160;
                </h:td>
                <h:td nowrap="nowrap">
                  <dcm:id ref="."/>
                  <dcm:attribute-editor ref="."/>
                  &#160;  
                  <xf:output value="concat('[',translate(@type,'_',' '),'] ')"/>&#160;
                </h:td>
                <h:td>  
                  <xf:repeat nodeset="t:author"><xf:output 
                    value="if ((position() &gt; 1) and (.!='')) then ', ' else ''"/><xf:output 
                      value="."/></xf:repeat><xf:output 
                        value="if (normalize-space(t:author[1]) and not(normalize-space(t:name[@role='recipient']))) then ': ' else ''"/>
                  <xf:output value="if (normalize-space(t:name[@role='recipient'])) then concat(' to ',t:name[@role='recipient']) else ''"/>
                  <h:i><xf:output value="t:title[@level='a']"/></h:i><xf:output 
                    value="if (normalize-space(t:title[@level='a']) and normalize-space(t:title[@level='j'])) then concat('. ',t:title[@level='j']) else t:title[@level='j']"/>
                  <xf:output value="if (normalize-space(t:title[@level='a']) and normalize-space(t:title[@level='m'])) then concat('. ',t:title[@level='m']) else t:title[@level='m']"/>
                  <xf:output value="if (normalize-space(t:date)) then concat('(',normalize-space(t:date),')') else ''"/>
                  <xf:group ref=".[normalize-space(concat(t:author[1],t:name[@role='recipient'],t:title[@level='a'],t:title[@level='j'],t:title[@level='m'],t:date))='']"> [No description] </xf:group>
                </h:td>
                <h:td nowrap="nowrap">
                  <xf:group ref=".[instance('temp')/file_exists='true']">
                    <xf:trigger>
                      <xf:label><h:img src="http:/editor/images/edit.gif" title="Open reference editor"/> Edit</xf:label>
                      <xf:action ev:event="DOMActivate">
                        <xxf:variable name="uri" 
                          select="concat(instance('parameters')/dcm:orbeon_dir,'?uri=',instance('parameters')/dcm:form_home,'reference_editor.xml&amp;doc=',instance('parameters')/dcm:xml_file,'&amp;id=',@xml:id)"/>
                        <xf:action if="instance('temp')/changed='true'">
                          <xf:setvalue ref="instance('temp')/target_uri" value="$uri"/>
                          <xxf:show dialog="exit-warning-dialog"/>
                        </xf:action>	
                        <xf:action if="instance('temp')/changed='false'">
                          <xf:load resource="{$uri}" show="replace"/>
                        </xf:action>
                      </xf:action>
                    </xf:trigger>
                  </xf:group>
                  <xf:group ref=".[instance('temp')/file_exists!='true']">
                    <h:small>File must be saved before references can be edited</h:small>
                  </xf:group>
                </h:td>
                <h:td class="buttons_cell" nowrap="nowrap"><dcm:element-buttons 
                  triggers="up down copy" 
                  nodeset="t:bibl" 
                  index="repeat-references"
                  origin="instance('data-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[1]/t:bibl[1]"/><xf:trigger appearance="minimal"
                    class="non-standard_button">
                    <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/></xf:label>
                    <xf:action ev:event="DOMActivate">
                      <xxf:show dialog="add-ref-dialog"/>
                    </xf:action>
                  </xf:trigger><dcm:element-buttons 
                    triggers="remove" 
                    nodeset="t:bibl" 
                    index="repeat-references"
                    origin="instance('empty-instance')/m:meiHead/m:fileDesc/m:notesStmt/m:annot[@type='bibliography']/t:listBibl[1]/t:bibl[1]"/>
                </h:td>
              </h:tr>
            </xf:repeat>
          </h:table>
          
        </h:fieldset>
      </xf:repeat>
      
    </xf:group>
    
  </h:div>  
  <h:br clear="all"/>  
</h:div>
