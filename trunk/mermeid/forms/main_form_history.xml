<?xml version="1.0" encoding="UTF-8" ?>
<h:div id="history-div" 
	xmlns:h="http://www.w3.org/1999/xhtml" 
	xmlns:t="http://www.tei-c.org/ns/1.0" 
	xmlns:xf="http://www.w3.org/2002/xforms"
	xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
	xmlns:xi="http://www.w3.org/2001/XInclude" 
	xmlns:ev="http://www.w3.org/2001/xml-events" 
	xmlns:m="http://www.music-encoding.org/ns/mei"
	xmlns:dcm="http://www.kb.dk/dcm">
	
	
	<h:div class="inputdiv">
		
		<xf:group ref="instance('data-instance')/m:meiHead/m:workDesc/m:work/m:history">
			<h:fieldset>
				<h:legend>Creation</h:legend>
				<h:div class="vertical_spacer"/>
				<dcm:date-editor ref="m:creation/m:date" style="display:inline;">
					<xf:label class="fixed_width_mediumlong">Date of composition <h:a class="help">?<h:span class="comment">Date or time span 
						of composition</h:span></h:a></xf:label>
				</dcm:date-editor>
				<xf:input ref="m:creation/m:geogName" class="long">
					<xf:label class="fixed_width_mediumlong">Place of composition </xf:label>
				</xf:input>
				<!--<dcm:attribute-editor ref="m:creation/m:geogName[instance('conf')/dcm:attr='true']"/>-->
				<xf:textarea ref="m:p" class="notes">
					<xf:label class="blocklabel">Creation note <h:a class="help">?<h:span class="comment">Text
						explaining details and circumstances concerning the work's genesis and history</h:span></h:a>
						<h:a class="help_plain"><h:img src="http:/editor/images/html_markup.gif" alt="HTML markup allowed"
						/><h:span class="comment">HTML markup and special characters allowed</h:span></h:a>
					</xf:label>
				</xf:textarea>
				<!--<dcm:attribute-editor ref="m:p[instance('conf')/dcm:attr='true']"/>-->
			</h:fieldset>
			<h:fieldset>
				<h:legend>Time line <h:a class="help">?<h:span class="comment">A list of events related to the work. The list
					may contain all kinds of events, whether related the compositional process, 
					the work's transmission, its reception or other aspects of its history</h:span></h:a>
					<!--<dcm:attribute-editor ref="m:eventList[@type='history'][instance('conf')/dcm:attr='true']"/>-->
				</h:legend>
				<xf:repeat nodeset="m:eventList[@type='history']/m:event" id="repeat-work-history">
					<h:fieldset>
						<h:legend>Event <dcm:element-buttons 
							triggers="all" 
							nodeset="m:event" 
							index="repeat-work-history"
							origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:history/m:eventList[@type='history']/m:event"/>
							<!--<dcm:attribute-editor ref=".[instance('conf')/dcm:attr='true']"/>-->
							<h:br clear="all"/>
						</h:legend>
						<xf:group ref="m:date">
							<xf:label class="fixed_width">Date <h:a class="help">?<h:span class="comment">Date 
								or date span of the event</h:span></h:a></xf:label>
							<dcm:date-editor ref="."/>
						</xf:group>
						<xf:input ref="m:title" class="long">
							<xf:label class="fixed_width">Description <h:a class="help">?<h:span class="comment">A description of the 
								event, e.g. "Third movement finished" or "Arranged for piano by NN"</h:span></h:a></xf:label>
						</xf:input>
						<!--<dcm:attribute-editor ref="m:title[instance('conf')/dcm:attr='true']"/>-->
					</h:fieldset>					
				</xf:repeat>
			</h:fieldset>
			
			<!-- List work level performances -->
			<xf:group ref="m:eventList[@type='performances']">
				<h:fieldset>
					<h:legend>Performances</h:legend>
					<h:br/>
					<h:div class="strong">
						Level: Work 
						<h:a class="help">?<h:span class="comment">Performances may be listed at work level and at version level. 
							Listing performances of individual versions requires that versions  
							have been defined (on the Music tab) and that they have been given a title 
							in order to make them recognizable as versions.</h:span></h:a>
					</h:div>
					<h:br/>
					<h:table class="element_list" cellspacing="0" cellpadding="0" border="0">
						<xf:repeat nodeset="m:event" id="repeat-work-performance">
							<h:tr class="hoverclass">
								<h:td class="number_cell">
									<xf:output value="position()"/>&#160;
								</h:td>
								<h:td>&#160;
									<xf:output value="concat(m:date,' ',m:geogName[2],' ',m:geogName[1])"/>
									<xf:group ref=".[normalize-space(m:title)!='']"> (<xf:output value="m:title"/>) </xf:group>
									<xf:group ref=".[normalize-space(concat(m:title,m:date,m:geogName[2],m:geogName[1]))='']"> [Empty] </xf:group>
								</h:td>
								<h:td>
									<dcm:id ref="."/>
									<xf:group ref=".[instance('temp')/file_exists='true']">
										<xf:trigger>
											<xf:label><h:img src="http:/editor/images/edit.gif" title="Open performance editor"/> Edit</xf:label>
											<xf:action ev:event="DOMActivate">
												<xxf:variable name="uri" 
													select="concat(instance('parameters')/dcm:orbeon_dir,'?uri=',instance('parameters')/dcm:form_home,'performance_editor.xml&amp;doc=',instance('parameters')/dcm:xml_file,'&amp;id=',@xml:id)"/>
												<xf:action if="instance('temp')/changed='true'">
													<xf:setvalue ref="instance('temp')/target_uri" value="$uri"/>
													<xxf:show dialog="exit-warning-dialog"/>
												</xf:action>	
												<xf:action if="instance('temp')/changed='false'">
													<xf:load resource="{$uri}" show="replace"/>
												</xf:action>
											</xf:action>
										</xf:trigger>
									</xf:group>
									<xf:group ref=".[instance('temp')/file_exists!='true']">
										<h:small>File must be saved before performances can be edited</h:small>
									</xf:group>
								</h:td>
								<h:td class="buttons_cell"><dcm:element-buttons triggers="all" nodeset="m:event" index="repeat-work-performance" 
									origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:history/m:eventList[@type='performances']/m:event"/></h:td>
							</h:tr>
						</xf:repeat>
					</h:table>
				</h:fieldset>
			</xf:group>
			
			
		</xf:group>
		
		<xf:group ref="instance('data-instance')/m:meiHead/m:workDesc/m:work">			
			<!-- list performances for versions with a title only (i.e. expressions marked as not being the only one) -->
			<xf:repeat nodeset="m:expressionList/m:expression[m:titleStmt/m:title[normalize-space(.)]]" id="repeat-expression-performances">				
				<xf:group ref="m:history/m:eventList[@type='performances']">
					<h:fieldset>
						<!-- get expression title -->
						<xxf:variable name="title" select="../../m:titleStmt/m:title[1]"/>
						<h:legend>Performances
							<xf:group ref=".[normalize-space($title)!='']">
								<xf:output value="concat(' - ',$title)"/>
							</xf:group>
						</h:legend>
						<h:p class="blocklabel">
							Level: Version 
							<h:a class="help">?<h:span class="comment">Performances may be listed at work level and at version level. 
								Listing performances of individual versions requires that versions  
								have been defined (on the Music tab) and that they have been given a title 
								in order to make them recognizable as versions.</h:span></h:a>
						</h:p>
						<h:table class="element_list" cellspacing="0" cellpadding="0" border="0">
							<xf:repeat nodeset="m:event" id="repeat-expression-performance">
								<h:tr class="hoverclass">
									<h:td class="number_cell">
										<xf:output value="position()"/>&#160;
									</h:td>
									<h:td>&#160;
										<xf:output value="concat(m:date,' ',m:geogName[2],' ',m:geogName[1])"/>
										<xf:group ref=".[normalize-space(m:title)!='']"> (<xf:output value="m:title"/>) </xf:group>
										<xf:group ref=".[normalize-space(concat(m:title,m:date,m:geogName[2],m:geogName[1]))='']"> [Empty] </xf:group>
									</h:td>
									<h:td>
										<dcm:id ref="."/>
										<xf:trigger>
											<xf:label><h:img src="http:/editor/images/edit.gif" title="Open performance editor"/> Edit</xf:label>
											<xf:action ev:event="DOMActivate">
												<xxf:variable name="uri" 
													select="concat(instance('parameters')/dcm:orbeon_dir,'?uri=',instance('parameters')/dcm:form_home,'performance_editor.xml&amp;doc=',instance('parameters')/dcm:xml_file,'&amp;id=',@xml:id)"/>
												<xf:action if="instance('temp')/changed='true'">
													<xf:setvalue ref="instance('temp')/target_uri" value="$uri"/>
													<xxf:show dialog="exit-warning-dialog"/>
												</xf:action>	
												<xf:action if="instance('temp')/changed='false'">
													<xf:load resource="{$uri}" show="replace"/>
												</xf:action>
											</xf:action>
										</xf:trigger>
									</h:td>
									<h:td class="buttons_cell"><dcm:element-buttons triggers="all" nodeset="m:event" index="repeat-expression-performance" 
										origin="instance('empty-instance')/m:meiHead/m:workDesc/m:work/m:history/m:eventList[@type='performances']/m:event"/></h:td>
								</h:tr>
							</xf:repeat>
						</h:table>
					</h:fieldset>
				</xf:group>
			</xf:repeat>
		</xf:group>
		
	</h:div>
	
	<h:br clear="all"/>
	
</h:div>
