<?xml version="1.0" encoding="UTF-8"?>
<h:html xmlns:h="http://www.w3.org/1999/xhtml" 
    xmlns:xi="http://www.w3.org/2001/XInclude"
    xmlns:xf="http://www.w3.org/2002/xforms" 
    xmlns:xxf="http://orbeon.org/oxf/xml/xforms"
    xmlns:ev="http://www.w3.org/2001/xml-events" 
    xmlns:m="http://www.music-encoding.org/ns/mei"
    xmlns:t="http://www.tei-c.org/ns/1.0" 
    xmlns:dcm="http://www.kb.dk/dcm">
    
    <!--
        Standard bibliographic references editor 
        Danish Centre for Music Publication (DCM) 
        Axel Teich Geertinger, 2012
        atge@kb.dk
    -->
    
    <xi:include href="model-edit-head.xml" parse="xml"/>
    
    <h:body class="file">
        
        <xf:group id="form-group">
            
            <xi:include href="edit-form-event-handlers.xml" parse="xml"/>
            <xxf:variable name="uri" 
                select="xxf:get-session-attribute('return_url')"/>
            
            <h:div class="inputdiv">
                
                <h:div style="float:right">
                    <xf:submit submission="save-to-file">
                        <xf:label><h:img src="http:/editor/images/save_small.png" alt="Save"/> Save</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:setvalue ref="instance('temp')/target_uri" 
                                value="concat(instance('parameters')/dcm:form_home,'model/standard_bibliography.xml')"/>
                        </xf:action>
                    </xf:submit>
                    <xf:submit submission="save-to-file">
                        <xf:label><h:img src="http:/editor/images/save_and_close.png" alt="Save and close"/> Save &amp; close</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:setvalue ref="instance('temp')/target_uri" 
                                value="concat(instance('parameters')/dcm:form_home,'model/standard_bibliography.xml')"/>
                            <xf:load resource="{xxf:get-session-attribute('return_url')}" show="replace"/>
                        </xf:action>
                    </xf:submit>
                    <xf:trigger>
                        <xf:label><h:img src="http:/editor/images/close.gif" alt="Cancel (close)"/> Cancel</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:load resource="{xxf:get-session-attribute('return_url')}" show="replace"/>
                        </xf:action>
                    </xf:trigger>
                </h:div>
                
                <h:h3>Edit list of frequently used bibliographic references</h:h3>
                
                <h:div>
                    <xf:select1 ref="instance('temp')/collection" class="maxlong">
                        <xf:label>Select existing file collection bibliography: </xf:label>
                        <xf:item>
                            <xf:label>General (available in all collections)</xf:label>
                            <xf:value/>
                        </xf:item>
                        <xf:itemset nodeset="instance('bibliography-instance')/t:listBibl">
                            <xf:label><xf:output value="@type"/></xf:label>
                            <xf:value ref="@type"></xf:value>
                        </xf:itemset>
                    </xf:select1>
                    <h:div class="vertical_spacer"/>
                    <xf:trigger ref=".[not(instance('XMLfiles')/*)]">
                        <xf:label>Search for more collections</xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:send submission="load-fileList"/>
                        </xf:action> 
                    </xf:trigger>
                    <xf:group ref=".[instance('XMLfiles')/* and 
                        not(instance('XMLfiles')/dcm:collections/dcm:collection[count(.[.=instance('bibliography-instance')/t:listBibl/@type])=0])]">
                        <h:div>No (other) file collections found.</h:div>
                    </xf:group>
                    <xf:group ref=".[instance('XMLfiles')/dcm:collections/dcm:collection[count(.[.=instance('bibliography-instance')/t:listBibl/@type])=0]]">                   
                        <xf:select1 ref="instance('temp')/new">
                            <xf:label>Or add new collection bibliography: </xf:label>
                            <xf:item>
                                <xf:label>- Please select -</xf:label>
                                <xf:value/>
                            </xf:item>
                            <xf:itemset nodeset="instance('XMLfiles')/dcm:collections/dcm:collection[count(.[.=instance('bibliography-instance')/t:listBibl/@type])=0]">
                                <xf:label><xf:output value="."/></xf:label>
                                <xf:value ref="."></xf:value>
                            </xf:itemset>
                        </xf:select1>
                        <xf:trigger>
                            <xf:label>Add</xf:label>
                            <xf:action ev:event="DOMActivate" if="normalize-space(instance('temp')/new) 
                                and instance('bibliography-instance')/t:listBibl[@type=instance('temp')/new]">
                                <xf:message>Collection already exists</xf:message>
                                <xf:setvalue ref="instance('temp')/collection" value="instance('temp')/new"/>
                            </xf:action>
                            <xf:action ev:event="DOMActivate" if="normalize-space(instance('temp')/new) 
                                and not (instance('bibliography-instance')/t:listBibl[@type=instance('temp')/new])">
                                <xf:insert
                                    context="instance('bibliography-instance')"
                                    nodeset="t:listBibl"
                                    at="last()"
                                    position="after"
                                    origin="instance('temp')/t:listBibl"
                                />
                                <xf:setvalue ref="instance('bibliography-instance')/t:listBibl[last()]/@type" value="instance('temp')/new"/>
                                <xf:setvalue ref="instance('temp')/collection" value="instance('temp')/new"/>
                            </xf:action>
                        </xf:trigger>
                    </xf:group>
                </h:div>
                <h:br/>
                <xf:trigger ref=".[not(instance('bibliography-instance')/t:listBibl[@type=instance('temp')/collection or (not(@type) and instance('temp')/collection='')]/t:bibl)]">
                    <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/> Add reference</xf:label>
                    <xf:action ev:event="DOMActivate">
                        <xxf:show dialog="add-ref-dialog"/>
                    </xf:action>
                </xf:trigger>
                <xf:repeat id="repeat-references"
                    nodeset="instance('bibliography-instance')/t:listBibl[@type=instance('temp')/collection or (not(@type) and instance('temp')/collection='')]/t:bibl">
                    <h:fieldset>
                        <h:legend>
                            <xf:output value="translate(concat(translate(substring(@type,1,1),'abcdefghijklmnopqrstuvwxyz','ABCDEFGHIJKLMNOPQRSTUVWXYZ'),substring(@type,2)),'_',' ')"/>
                            <dcm:element-buttons 
                                triggers="up down copy" 
                                nodeset="t:bibl" 
                                index="repeat-references"
                                origin="instance('temp')/t:listBibl/t:bibl"/><xf:trigger appearance="minimal"
                                    class="non-standard_button">
                                    <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/></xf:label>
                                    <xf:action ev:event="DOMActivate">
                                        <xxf:show dialog="add-ref-dialog"/>
                                    </xf:action>
                                </xf:trigger><dcm:element-buttons 
                                    triggers="remove" 
                                    nodeset="t:bibl" 
                                    index="repeat-references"
                                    origin="instance('temp')/t:listBibl/t:bibl"/>
                        </h:legend>
                        <h:div class="vertical_spacer"> </h:div>
                        <xf:switch>
                            <xf:case id="hide_reference">
                                <h:div style="float:right">
                                    <xf:trigger>
                                        <xf:label>Show details</xf:label>
                                        <xf:action ev:event="DOMActivate">
                                            <xf:toggle case="show_reference"/>
                                        </xf:action>
                                    </xf:trigger>
                                </h:div>
                                <xf:repeat nodeset="t:author"><xf:output 
                                    value="if ((position() &gt; 1) and (.!='')) then ', ' else ''"/><xf:output 
                                        value="."/></xf:repeat><xf:output 
                                            value="if (normalize-space(t:author[1]) and not(normalize-space(t:name[@role='recipient']))) then ': ' else ''"/>
                                <xf:output value="if (normalize-space(t:name[@role='recipient'])) then concat(' to ',t:name[@role='recipient']) else ''"/>
                                <h:i><xf:output value="t:title[@level='a']"/></h:i><xf:output 
                                    value="if (normalize-space(t:title[@level='a']) and normalize-space(t:title[@level='j'])) then concat('. ',t:title[@level='j']) else t:title[@level='j']"/>
                                <xf:output value="if (normalize-space(t:title[@level='a']) and normalize-space(t:title[@level='m'])) then concat('. ',t:title[@level='m']) else t:title[@level='m']"/>
                                <xf:output value="if (normalize-space(t:date)) then concat('(',normalize-space(t:date),')') else ''"/>
                                <xf:group ref=".[normalize-space(concat(t:author[1],t:name[@role='recipient'],t:title[@level='a'],t:title[@level='j'],t:title[@level='m'],t:date))='']"> [No description] </xf:group>
                            </xf:case>
                            <xf:case id="show_reference">
                                <h:div style="float:right">
                                    <xf:trigger>
                                        <xf:label>Hide details</xf:label>
                                        <xf:action ev:event="DOMActivate">
                                            <xf:toggle case="hide_reference"/>
                                        </xf:action>
                                    </xf:trigger>
                                </h:div>
                                <xi:include href="includes/bibl-input.xml" parse="xml"/>
                            </xf:case>
                        </xf:switch>
                    </h:fieldset>
                </xf:repeat>
            </h:div>
            
        </xf:group>
        
        <!-- reference types menu -->
        <xxf:dialog id="add-ref-dialog" appearance="full" level="modal"
            close="true" draggable="true" visible="false">
            <h:div class="blocklabel">Add new reference:</h:div>
            <h:br clear="all"/>
            <xf:repeat nodeset="instance('bibl-type-instance')/t:listBibl" id="ref-type-menu-listbibl-repeat">
                <xf:repeat nodeset="t:bibl[not(@type=parent::node()/preceding-sibling::t:listBibl/t:bibl/@type)]" id="ref-type-menu-bibl-repeat">
                    <xf:trigger submission="replace-form-with" appearance="minimal">
                        <xf:label><h:img src="http:/editor/images/add.gif" alt="Add"/> <xf:output ref="translate(@type,'_',' ')"/></xf:label>
                        <xf:action ev:event="DOMActivate">
                            <xf:toggle case="hide_ref_types"/>
                            <xf:insert context="instance('bibliography-instance')/t:listBibl[@type=instance('temp')/collection or (not(@type) and instance('temp')/collection='')]" 
                                nodeset="t:bibl" 
                                at="index('repeat-references')"
                                position="after" 
                                origin="instance('bibl-type-instance')/t:listBibl[index('ref-type-menu-listbibl-repeat')]/t:bibl[index('ref-type-menu-bibl-repeat')]"/>
                            <xf:dispatch name="id-update" target="form-group"/>
                            <xxf:hide dialog="add-ref-dialog"/>
                        </xf:action>
                    </xf:trigger>
                    <h:br clear="all"/>
                </xf:repeat>
            </xf:repeat>
        </xxf:dialog>
        <!-- end menu -->
        
        <xf:group ref=".[instance('parameters')/dcm:code_inspector='true']">
            <fr:xforms-inspector xmlns:fr="http://orbeon.org/oxf/xml/form-runner"/>
        </xf:group>
        
        <h:br clear="all"/>
        
        <xi:include href="edit-form-footer.xml" parse="xml"/>
    </h:body>
</h:html>
